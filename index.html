<!DOCTYPE html>
<html>
<head>
	<title>Cloudiopsy </title>
	<link href="https://fonts.googleapis.com/css?family=Lato:300,700" rel="stylesheet">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="style.css" type="text/css" rel="stylesheet"/>

	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.1/dist/tf.min.js"></script>

	<script>
		
	   function previewFile(){
	       var preview = document.querySelector('img[class=preview]'); 
	       var file    = document.querySelector('input[type=file]').files[0];
	       var reader  = new FileReader();

	       reader.onloadend = function () {
	           preview.src = reader.result;
	       }

	       if (file) {
	           reader.readAsDataURL(file); 
	       } else {
	           preview.src = "NORM-FPDCNHFY.jpg";
              preview.crossOrigin = "anonymous";
	       }
   	   }

   	   function analyze() {
   	   		var file    = document.querySelector('input[type=file]').files[0]; 
   	   		if (file) {
   	   			runModel(file)
   	   		} else {
   	   			runModel(document.querySelector('img[src="NORM-FPDCNHFY.jpg"]'));
   	   		}
   	   }


   	   async function runModel(file) {

   	   		const model = await tf.loadModel('https://cloudiopsy.github.io/model.json');

   	   		// Convert image to tensor
   	   		let fileName = file.name;

               // image = document.querySelector('img[src="NORM-FPDCNHFY.jpg"]'); 
               // image.crossOrigin = 'anonymous';

   	   		let img_tensor = tf.fromPixels(document.getElementById("preview")).resizeNearestNeighbor([224, 224]);
   	   		img_tensor = tf.expandDims(img_tensor, axis=0);

   	   		img_tensor = tf.div(img_tensor, 255);
   	   		let predictions = await model.predict(img_tensor).data();

               let percent = ((1 - predictions[0]) * 100).toFixed(2)

               document.getElementById("loader").style.display = "none";
               if(percent > 50) {
      	   		if(predictions[0] < 0.25) {
                     alert(predictions)
      	   			document.getElementById("prediction-text").innerHTML = "File name: " + fileName+ "<br/>This tissue is normal!";
      	   		} else {
                     alert(predictions)
      	   			document.getElementById("prediction-text").innerHTML ="File name: " + fileName+ "<br/>This tissue is tumour!";
      	   		}
               } else {
                  document.getElementById("prediction-text").innerHTML = "The model is uncertain. Please try a different image.";
               }


   	   }




</script>

</head>
<body onload="document.getElementById('loader').style.display = 'none'">

<div id="loader">
</div>


<div class="header info">
<div class="header-text">
 CLOUDIOPSY <img src="logo.png"/>
</div>
<div class="subheader">
A Colorectal Cancer Prediction Platform created through
<br/> Tensorflow
</div>

<div class="side-image">
<img src="cancer.png"/>
</div>
</div>


<label class="custom-file-upload">
   <div class="submission upload">
    <span class="glyphicon glyphicon-open"> 
	</span> UPLOAD </label>
	</div>
	<input name="img" type="file" accept="image/*" onclick="window.location.hash = '';window.location.hash = 'analysis-section'" onchange="previewFile()"/>
</label>


<div id="analysis-section">
<h1>Click Analyze to Run the Neural Network! See deafault!</h1> 
<img src="NORM-FPDCNHFY.jpg" class="preview" id="preview" alt="Image preview"/>

<p id="prediction-text"></p>

<button class="submission analyze" onclick="
document.getElementById('prediction-text').innerHTML = ''; 
document.getElementById('loader').style.display = 'inline'; 
analyze()"> <span class="glyphicon glyphicon glyphicon-stats"> 
	</span> ANALYZE </label>
</button>


</div>





</body>
</html>